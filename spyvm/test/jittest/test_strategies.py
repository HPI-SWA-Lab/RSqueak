import py

from .base import BaseJITTest


class TestBasic(BaseJITTest):

     # TODO: there shouldnt be allocations in this
    def test_range_asOrderedCollection(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000) asOrderedCollection.
        """)
        self.assert_matches(traces[0].loop, """
 guard_not_invalidated(descr=<Guard0x2b713d0>),
 p173 = getarrayitem_gc(p53, 1, descr=<ArrayP 4>),
 i174 = getfield_gc_pure(p173, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i175 = int_ge(i174, i167),
 guard_true(i175, descr=<Guard0x2b81490>),
 cond_call(i75, 4712800, p67, descr=<Callv 0 r EF=2 OS=121>),
 cond_call(i103, 4712800, p91, descr=<Callv 0 r EF=2 OS=121>),
 cond_call(i103, 4712800, p91, descr=<Callv 0 r EF=2 OS=121>),
 p176 = getarrayitem_gc(p105, 0, descr=<ArrayP 4>),
 cond_call(i103, 4712800, p91, descr=<Callv 0 r EF=2 OS=121>),
 p178 = new_with_vtable(ConstClass(W_SmallInteger)),
 setfield_gc(p178, i167, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 setarrayitem_gc(p105, 1, p178, descr=<ArrayP 4>),
 setarrayitem_gc(p79, 0, p176, descr=<ArrayP 4>),
 setfield_gc(p67, 2, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>),
 setfield_gc(p67, 15, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>),
 setfield_gc(p67, p0, descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>),
 setfield_gc(ConstPtr(ptr81), i88, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 setarrayitem_gc(p79, 1, p178, descr=<ArrayP 4>),
 guard_class(p176, 6040288, descr=<Guard0x2b81410>),
 p179 = getfield_gc(p176, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_s_class 12>),
 guard_value(p179, ConstPtr(ptr117), descr=<Guard0x2b81390>),
 p180 = getfield_gc(p176, descr=<FieldP spyvm.model.W_AbstractPointersObject.inst__shadow 20>),
 setarrayitem_gc(p79, 0, ConstPtr(null), descr=<ArrayP 4>),
 setfield_gc(p67, 0, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>),
 setfield_gc(ConstPtr(ptr81), i129, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 setarrayitem_gc(p79, 1, ConstPtr(null), descr=<ArrayP 4>),
 guard_isnull(p180, descr=<Guard0x2b81310>),
 p183 = getfield_gc(p176, descr=<FieldP spyvm.model.W_PointersObject.inst_fieldtypes 28>),
 guard_value(p183, ConstPtr(ptr133), descr=<Guard0x2b81290>),
 p184 = getfield_gc(p176, descr=<FieldP spyvm.model.W_PointersObject.inst__vars 24>),
 p185 = getarrayitem_gc(p184, 2, descr=<ArrayP 4>),
 p186 = getarrayitem_gc(p184, 0, descr=<ArrayP 4>),
 guard_class(p186, 6040288, descr=<Guard0x2b81210>),
 p187 = getfield_gc(p186, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_s_class 12>),
 guard_value(p187, ConstPtr(ptr144), descr=<Guard0x2b81190>),
 p188 = getfield_gc(p186, descr=<FieldP spyvm.model.W_AbstractPointersObject.inst__shadow 20>),
 guard_isnull(p188, descr=<Guard0x2b81110>),
 p189 = getfield_gc(p186, descr=<FieldP spyvm.model.W_PointersObject.inst__vars 24>),
 i190 = arraylen_gc(p189, descr=<ArrayP 4>),
 i191 = getfield_gc_pure(p185, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i192 = int_eq(i191, i190),
 guard_false(i192, descr=<Guard0x2b81090>),
 i193 = int_add_ovf(i191, 1),
 guard_no_overflow(descr=<Guard0x2b81010>),
 i194 = int_ge(i191, 0),
 guard_true(i194, descr=<Guard0x2b71f50>),
 i195 = int_lt(i191, i190),
 guard_true(i195, descr=<Guard0x2b71ed0>),
 p196 = getfield_gc(p186, descr=<FieldP spyvm.model.W_PointersObject.inst_fieldtypes 28>),
 guard_value(p196, ConstPtr(ptr156), descr=<Guard0x2b71e50>),
 p197 = new_with_vtable(ConstClass(W_SmallInteger)),
 setfield_gc(p197, i193, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 setarrayitem_gc(p184, 2, p197, descr=<ArrayP 4>),
 setarrayitem_gc(p189, i191, p178, descr=<ArrayP 4>),
 p198 = getarrayitem_gc(p53, 2, descr=<ArrayP 4>),
 i199 = getfield_gc_pure(p198, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 setarrayitem_gc(p79, 0, ConstPtr(null), descr=<ArrayP 4>),
 setfield_gc(p67, -1, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>),
 setfield_gc(p67, ConstPtr(null), descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>),
 setfield_gc(ConstPtr(ptr81), i84, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 i200 = int_add_ovf(i167, i199),
 guard_no_overflow(descr=<Guard0x2b71dd0>),
 i201 = int_sub(i170, 8),
 setfield_gc(ConstPtr(ptr81), i201, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>),
 i202 = int_le(i201, 0),
 guard_false(i202, descr=<Guard0x2b71d50>),
 i203 = arraylen_gc(p53, descr=<ArrayP 4>),
 i204 = arraylen_gc(p79, descr=<ArrayP 4>),
 i205 = arraylen_gc(p105, descr=<ArrayP 4>),
 jump(p0, p3, p6, i200, p14, p16, p18, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, p53, i75, p67, i103, p91, p105, p79, i88, i90, i129, i84, i201, descr=TargetToken(45055856))]
        """)
        
    def test_indexOf(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000000) asOrderedCollection indexOf: 9999999.
        """)
        # First loop: asOrderedCollection, second loop: makeRoomAtLast
        self.assert_matches(traces[2].loop, """
 guard_not_invalidated(descr=<Guard0x2c45750>),
 i136 = int_le(i130, i62),
 guard_true(i136, descr=<Guard0x2c45310>),
 p137 = getarrayitem_gc(p88, 1, descr=<ArrayP 4>),
 setfield_gc(ConstPtr(ptr68), i75, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 guard_nonnull_class(p137, 19336136, descr=<Guard0x2c3e250>),
 i138 = getfield_gc_pure(p137, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i139 = int_add_ovf(i130, i138),
 guard_no_overflow(descr=<Guard0x2c3e1d0>),
 i140 = int_sub(i139, 1),
 p141 = getarrayitem_gc(p88, 2, descr=<ArrayP 4>),
 guard_nonnull_class(p141, 19336136, descr=<Guard0x2c32d90>),
 i142 = getfield_gc_pure(p141, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i143 = int_gt(i140, i142),
 guard_false(i143, descr=<Guard0x2c32d10>),
 p144 = getarrayitem_gc(p88, 0, descr=<ArrayP 4>),
 guard_class(p144, 19336008, descr=<Guard0x2c32450>),
 p145 = getfield_gc(p144, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_s_class 12>),
 guard_value(p145, ConstPtr(ptr105), descr=<Guard0x2c32410>),
 i146 = int_sub(i140, 1),
 i147 = int_ge(i146, 0),
 guard_true(i147, descr=<Guard0x2c32210>),
 p148 = call(ConstClass(elidable_func__star_0), p144, ConstPtr(ptr111), descr=<Callr 4 rr EF=0>),
 guard_isnull(p148, descr=<Guard0x2c321d0>),
 p149 = call(ConstClass(elidable_func__star_0), p144, ConstPtr(ptr114), descr=<Callr 4 rr EF=0>),
 guard_class(p149, 19374540, descr=<Guard0x2c32190>),
 p150 = call(ConstClass(elidable_func__star_0), p144, ConstPtr(ptr118), descr=<Callr 4 rr EF=0>),
 p151 = getfield_gc_pure(p150, descr=<FieldP spyvm.strategies.SparseSmallIntegerStorage.inst_arr 8>),
 i152 = arraylen_gc(p151, descr=<ArrayS 4>),
 i153 = int_lt(i146, i152),
 guard_true(i153, descr=<Guard0x2c32110>),
 p154 = getfield_gc_pure(p150, descr=<FieldP spyvm.strategies.SparseSmallIntegerStorage.inst_nil_flags 12>),
 i155 = getarrayitem_gc(p154, i146, descr=<ArrayU 1>),
 guard_false(i155, descr=<Guard0x2c5df90>),
 i156 = getarrayitem_gc(p151, i146, descr=<ArrayS 4>),
 setfield_gc(ConstPtr(ptr68), i71, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 i157 = int_eq(i156, i127),
 guard_false(i157, descr=<Guard0x2c5d9d0>),
 i158 = int_add_ovf(i130, 1),
 guard_no_overflow(descr=<Guard0x2c5d690>),
 i159 = int_sub(i133, 6),
 setfield_gc(ConstPtr(ptr68), i159, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>),
 i160 = int_le(i159, 0),
 guard_false(i160, descr=<Guard0x2c5d410>),
 i161 = arraylen_gc(p88, descr=<ArrayP 4>),
 jump(p0, p3, p6, p8, p10, i158, p14, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, p44, p46, p48, p50, p52, i57, i62, p88, i75, p64, i71, i127, i159, descr=TargetToken(49528736))
        """)
