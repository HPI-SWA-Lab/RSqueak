import py

from .base import BaseJITTest

class TestBasic(BaseJITTest):

     # TODO: there shouldnt be allocations in this
     # The cond_call operations should also not show up...
    def test_range_asOrderedCollection(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000) asOrderedCollection.
        """)
        self.assert_matches(traces[0].loop, """
            guard_not_invalidated(descr=<Guard0x3318d10>),
            i190 = getarrayitem_gc(p52, 1, descr=<ArrayS 4>),
            i191 = int_eq(i190, 2147483647),
            guard_false(i191, descr=<Guard0x3318ad0>),
            i192 = int_ge(i190, i184),
            guard_true(i192, descr=<Guard0x3318810>),
            cond_call(i74, 16971392, p66, descr=<Callv 0 r EF=2 OS=121>),
            cond_call(i102, 16971392, p90, descr=<Callv 0 r EF=2 OS=121>),
            cond_call(i102, 16971392, p90, descr=<Callv 0 r EF=2 OS=121>),
            p193 = getarrayitem_gc(p104, 0, descr=<ArrayP 4>),
            cond_call(i102, 16971392, p90, descr=<Callv 0 r EF=2 OS=121>),
            p195 = new_with_vtable(18295080),
            setfield_gc(p195, i184, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
            setarrayitem_gc(p104, 1, p195, descr=<ArrayP 4>),
            setarrayitem_gc(p78, 0, p193, descr=<ArrayP 4>),
            setfield_gc(p66, 2, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>),
            setfield_gc(p66, 15, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>),
            setfield_gc(p66, p0, descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>),
            setfield_gc(ConstPtr(ptr80), i87, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
            setarrayitem_gc(p78, 1, p195, descr=<ArrayP 4>),
            guard_class(p193, 18294904, descr=<Guard0x32f9d90>),
            p196 = getfield_gc(p193, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_w_class 12>),
            p197 = getfield_gc(p196, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>),
            guard_value(p197, ConstPtr(ptr117), descr=<Guard0x32f9e10>),
            p198 = getfield_gc(p193, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>),
            setarrayitem_gc(p78, 0, ConstPtr(null), descr=<ArrayP 4>),
            setfield_gc(p66, 0, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>),
            setfield_gc(ConstPtr(ptr80), i131, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
            setarrayitem_gc(p78, 1, ConstPtr(null), descr=<ArrayP 4>),
            guard_class(p198, ConstClass(ListStorageShadow), descr=<Guard0x3311a90>),
            p201 = getfield_gc_pure(p198, descr=<FieldP spyvm.shadow.ListStorageShadow.inst_storage 16>),
            p202 = getarrayitem_gc(p201, 2, descr=<ArrayP 4>),
            p203 = getarrayitem_gc(p201, 0, descr=<ArrayP 4>),
            guard_class(p203, 18294904, descr=<Guard0x3311750>),
            p204 = getfield_gc(p203, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_w_class 12>),
            p205 = getfield_gc(p204, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>),
            guard_value(p205, ConstPtr(ptr149), descr=<Guard0x3311710>),
            p206 = getfield_gc(p203, descr=<FieldP spyvm.model.W_PointersObject.inst_shadow 16>),
            guard_nonnull_class(p206, 18300088, descr=<Guard0x3311450>),
            p207 = getfield_gc_pure(p206, descr=<FieldP spyvm.shadow.SmallIntegerOrNilStorageShadow.inst_storage 16>),
            i208 = arraylen_gc(p207, descr=<ArrayS 4>),
            i209 = getfield_gc_pure(p206, descr=<FieldU spyvm.shadow.AbstractShadow.inst_space 12>),
            guard_nonnull_class(p202, 18295080, descr=<Guard0x33112d0>),
            i210 = getfield_gc_pure(p202, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
            i211 = int_eq(i210, i208),
            guard_false(i211, descr=<Guard0x3311250>),
            i212 = int_add_ovf(i210, 1),
            guard_no_overflow(descr=<Guard0x330be50>),
            i213 = int_ge(i210, 0),
            guard_true(i213, descr=<Guard0x330b790>),
            i214 = int_lt(i210, i208),
            guard_true(i214, descr=<Guard0x330b710>),
            i215 = int_eq(i184, 2147483647),
            guard_false(i215, descr=<Guard0x330b610>),
            setarrayitem_gc(p207, i210, i184, descr=<ArrayS 4>),
            i216 = getarrayitem_gc(p52, 2, descr=<ArrayS 4>),
            setfield_gc(p66, -1, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>),
            setfield_gc(p66, ConstPtr(null), descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>),
            setfield_gc(ConstPtr(ptr80), i83, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
            i217 = int_eq(i216, 2147483647),
            guard_false(i217, descr=<Guard0x3304a50>),
            i218 = int_add_ovf(i184, i216),
            guard_no_overflow(descr=<Guard0x3304950>),
            i219 = int_sub(i187, 7),
            setfield_gc(ConstPtr(ptr80), i219, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>),
            i220 = int_le(i219, 0),
            guard_false(i220, descr=<Guard0x33046d0>),
            p221 = new_with_vtable(18295080),
            setfield_gc(p221, i212, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
            setarrayitem_gc(p201, 2, p221, descr=<ArrayP 4>),
            i222 = arraylen_gc(p52, descr=<ArrayS 4>),
            i223 = arraylen_gc(p78, descr=<ArrayP 4>),
            i224 = arraylen_gc(p104, descr=<ArrayP 4>),
            jump(p0, p3, p6, i218, p14, p16, p18, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, i47, p52, i74, p66, i102, p90, p104, p78, i87, i89, i131, i119, p145, i83, i219, descr=TargetToken(53064608)) 
        """)
        
    def test_indexOf(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000000) asOrderedCollection indexOf: 9999999.
        """)
        # First loop: asOrderedCollection, second loop: makeRoomAtLast
        self.assert_matches(traces[2].loop, """
            guard_not_invalidated(descr=<Guard0x2f28ed0>),
            i143 = int_le(i137, i62),
            guard_true(i143, descr=<Guard0x2f3c990>),
            setfield_gc(ConstPtr(ptr84), i91, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
            i144 = int_add_ovf(i137, i100),
            guard_no_overflow(descr=<Guard0x2f3c950>),
            i145 = int_sub(i144, 1),
            i146 = int_gt(i145, i108),
            guard_false(i146, descr=<Guard0x2f3c910>),
            i147 = int_sub(i145, 1),
            i148 = int_ge(i147, 0),
            guard_true(i148, descr=<Guard0x2f3c8d0>),
            i149 = int_lt(i147, i127),
            guard_true(i149, descr=<Guard0x2f3c890>),
            i150 = getarrayitem_gc(p126, i147, descr=<ArrayS 4>),
            i151 = int_eq(i150, 2147483647),
            guard_false(i151, descr=<Guard0x2f3c850>),
            setfield_gc(ConstPtr(ptr84), i87, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
            i152 = int_eq(i150, i134),
            guard_false(i152, descr=<Guard0x2f3c810>),
            i153 = int_add_ovf(i137, 1),
            guard_no_overflow(descr=<Guard0x2f3c7d0>),
            i154 = int_sub(i140, 5),
            setfield_gc(ConstPtr(ptr84), i154, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>),
            i155 = int_le(i154, 0),
            guard_false(i155, descr=<Guard0x2f3c790>),
            i156 = arraylen_gc(p96, descr=<ArrayP 4>),
            jump(p0, p3, p6, p8, p10, i153, p14, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, p44, p46, p48, p50, p52, i57, i62, i91, i100, p64, p98, i80, i108, p105, p111, i127, p126, i87, i134, i154, p96, descr=TargetToken(51324000))
        """)
