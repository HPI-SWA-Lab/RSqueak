import py

from .base import BaseJITTest

class TestBasic(BaseJITTest):

     # TODO: there shouldnt be allocations in this
     # The cond_call operations should also not show up...
    def test_range_asOrderedCollection(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000) asOrderedCollection.
        """)
        self.assert_matches(traces[0].loop, """
 guard_not_invalidated(descr=<Guard0x365f3d0>),
 p195 = getarrayitem_gc(p59, 1, descr=<ArrayP 4>),
 guard_nonnull_class(p195, 19336136, descr=<Guard0x365f350>),
 i196 = getfield_gc_pure(p195, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i197 = int_ge(i196, i189),
 guard_true(i197, descr=<Guard0x365f2d0>),
 cond_call(i84, 18017728, p76, descr=<Callv 0 r EF=2 OS=121>),
 cond_call(i114, 18017728, p102, descr=<Callv 0 r EF=2 OS=121>),
 cond_call(i114, 18017728, p102, descr=<Callv 0 r EF=2 OS=121>),
 p198 = getarrayitem_gc(p116, 0, descr=<ArrayP 4>),
 cond_call(i114, 18017728, p102, descr=<Callv 0 r EF=2 OS=121>),
 p200 = new_with_vtable(19336136),
 setfield_gc(p200, i189, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 setarrayitem_gc(p116, 1, p200, descr=<ArrayP 4>),
 setarrayitem_gc(p88, 0, p198, descr=<ArrayP 4>),
 setfield_gc(p76, 2, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>),
 setfield_gc(p76, 15, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>),
 setfield_gc(p76, p0, descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>),
 setfield_gc(ConstPtr(ptr90), i97, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 setarrayitem_gc(p88, 1, p200, descr=<ArrayP 4>),
 guard_class(p198, 19336008, descr=<Guard0x365f250>),
 p201 = getfield_gc(p198, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_s_class 12>),
 guard_value(p201, ConstPtr(ptr128), descr=<Guard0x365f1d0>),
 p202 = call(ConstClass(elidable_func__star_0), p198, ConstPtr(ptr139), descr=<Callr 4 rr EF=0>),
 setarrayitem_gc(p88, 0, ConstPtr(null), descr=<ArrayP 4>),
 setfield_gc(p76, 0, descr=<FieldU spyvm.shadow.ContextPartShadow.inst__stack_ptr 32>),
 setfield_gc(ConstPtr(ptr90), i137, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 setarrayitem_gc(p88, 1, ConstPtr(null), descr=<ArrayP 4>),
 guard_isnull(p202, descr=<Guard0x365f150>),
 p205 = call(ConstClass(elidable_func__star_0), p198, ConstPtr(ptr143), descr=<Callr 4 rr EF=0>),
 guard_class(p205, 19337240, descr=<Guard0x365f0d0>),
 p206 = call(ConstClass(elidable_func__star_0), p198, ConstPtr(ptr147), descr=<Callr 4 rr EF=0>),
 p207 = getarrayitem_gc(p206, 2, descr=<ArrayP 4>),
 p208 = getarrayitem_gc(p206, 0, descr=<ArrayP 4>),
 guard_class(p208, 19336008, descr=<Guard0x365f050>),
 p209 = getfield_gc(p208, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_s_class 12>),
 guard_value(p209, ConstPtr(ptr155), descr=<Guard0x365cf90>),
 p210 = call(ConstClass(elidable_func__star_0), p208, ConstPtr(ptr157), descr=<Callr 4 rr EF=0>),
 guard_isnull(p210, descr=<Guard0x365cf10>),
 p211 = call(ConstClass(elidable_func__star_0), p208, ConstPtr(ptr160), descr=<Callr 4 rr EF=0>),
 guard_class(p211, 19355992, descr=<Guard0x365ce90>),
 p212 = call(ConstClass(elidable_func__star_0), p208, ConstPtr(ptr164), descr=<Callr 4 rr EF=0>),
 p213 = getfield_gc_pure(p212, descr=<FieldP spyvm.strategies.DenseSmallIntegerStorage.inst_arr 16>),
 i214 = arraylen_gc(p213, descr=<ArrayS 4>),
 guard_nonnull_class(p207, 19336136, descr=<Guard0x365ce10>),
 i215 = getfield_gc_pure(p207, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i216 = int_eq(i215, i214),
 guard_false(i216, descr=<Guard0x365cd90>),
 i217 = int_add_ovf(i215, 1),
 guard_no_overflow(descr=<Guard0x365cd10>),
 i218 = int_ge(i215, 0),
 guard_true(i218, descr=<Guard0x365cc90>),
 i219 = int_lt(i215, i214),
 guard_true(i219, descr=<Guard0x365cc10>),
 i220 = getfield_gc(p212, descr=<FieldS spyvm.strategies.DenseSmallIntegerStorage.inst__to 12>),
 i221 = int_eq(i215, i220),
 guard_true(i221, descr=<Guard0x365cb90>),
 i222 = int_add(i220, 1),
 setarrayitem_gc(p213, i215, i189, descr=<ArrayS 4>),
 p223 = new_with_vtable(19336136),
 setfield_gc(p223, i217, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 setarrayitem_gc(p206, 2, p223, descr=<ArrayP 4>),
 p224 = getarrayitem_gc(p59, 2, descr=<ArrayP 4>),
 setfield_gc(p76, -1, descr=<FieldS spyvm.shadow.ContextPartShadow.inst__pc 24>),
 setfield_gc(p76, ConstPtr(null), descr=<FieldP spyvm.shadow.ContextPartShadow.inst__s_sender 28>),
 setfield_gc(ConstPtr(ptr90), i93, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 setfield_gc(p212, i222, descr=<FieldS spyvm.strategies.DenseSmallIntegerStorage.inst__to 12>),
 guard_nonnull_class(p224, 19336136, descr=<Guard0x365cb10>),
 i225 = getfield_gc_pure(p224, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i226 = int_add_ovf(i189, i225),
 guard_no_overflow(descr=<Guard0x365ca90>),
 i227 = int_sub(i192, 8),
 setfield_gc(ConstPtr(ptr90), i227, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>),
 i228 = int_le(i227, 0),
 guard_false(i228, descr=<Guard0x365ca10>),
 i229 = arraylen_gc(p59, descr=<ArrayP 4>),
 i230 = arraylen_gc(p88, descr=<ArrayP 4>),
 i231 = arraylen_gc(p116, descr=<ArrayP 4>),
 jump(p0, p3, p6, i226, p14, p16, p18, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, i47, p59, i84, p76, i114, p102, p116, p88, i97, i99, i137, i93, i227, descr=TargetToken(56538256))
        """)
        
    def test_indexOf(self, spy, tmpdir):
        traces = self.run(spy, tmpdir,
        """
        (1 to: 10000000) asOrderedCollection indexOf: 9999999.
        """)
        # First loop: asOrderedCollection, second loop: makeRoomAtLast
        self.assert_matches(traces[2].loop, """
 guard_not_invalidated(descr=<Guard0x2c45750>),
 i136 = int_le(i130, i62),
 guard_true(i136, descr=<Guard0x2c45310>),
 p137 = getarrayitem_gc(p88, 1, descr=<ArrayP 4>),
 setfield_gc(ConstPtr(ptr68), i75, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 guard_nonnull_class(p137, 19336136, descr=<Guard0x2c3e250>),
 i138 = getfield_gc_pure(p137, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i139 = int_add_ovf(i130, i138),
 guard_no_overflow(descr=<Guard0x2c3e1d0>),
 i140 = int_sub(i139, 1),
 p141 = getarrayitem_gc(p88, 2, descr=<ArrayP 4>),
 guard_nonnull_class(p141, 19336136, descr=<Guard0x2c32d90>),
 i142 = getfield_gc_pure(p141, descr=<FieldS spyvm.model.W_SmallInteger.inst_value 8>),
 i143 = int_gt(i140, i142),
 guard_false(i143, descr=<Guard0x2c32d10>),
 p144 = getarrayitem_gc(p88, 0, descr=<ArrayP 4>),
 guard_class(p144, 19336008, descr=<Guard0x2c32450>),
 p145 = getfield_gc(p144, descr=<FieldP spyvm.model.W_AbstractObjectWithClassReference.inst_s_class 12>),
 guard_value(p145, ConstPtr(ptr105), descr=<Guard0x2c32410>),
 i146 = int_sub(i140, 1),
 i147 = int_ge(i146, 0),
 guard_true(i147, descr=<Guard0x2c32210>),
 p148 = call(ConstClass(elidable_func__star_0), p144, ConstPtr(ptr111), descr=<Callr 4 rr EF=0>),
 guard_isnull(p148, descr=<Guard0x2c321d0>),
 p149 = call(ConstClass(elidable_func__star_0), p144, ConstPtr(ptr114), descr=<Callr 4 rr EF=0>),
 guard_class(p149, 19374540, descr=<Guard0x2c32190>),
 p150 = call(ConstClass(elidable_func__star_0), p144, ConstPtr(ptr118), descr=<Callr 4 rr EF=0>),
 p151 = getfield_gc_pure(p150, descr=<FieldP spyvm.strategies.SparseSmallIntegerStorage.inst_arr 8>),
 i152 = arraylen_gc(p151, descr=<ArrayS 4>),
 i153 = int_lt(i146, i152),
 guard_true(i153, descr=<Guard0x2c32110>),
 p154 = getfield_gc_pure(p150, descr=<FieldP spyvm.strategies.SparseSmallIntegerStorage.inst_nil_flags 12>),
 i155 = getarrayitem_gc(p154, i146, descr=<ArrayU 1>),
 guard_false(i155, descr=<Guard0x2c5df90>),
 i156 = getarrayitem_gc(p151, i146, descr=<ArrayS 4>),
 setfield_gc(ConstPtr(ptr68), i71, descr=<FieldS spyvm.interpreter.Interpreter.inst_remaining_stack_depth 40>),
 i157 = int_eq(i156, i127),
 guard_false(i157, descr=<Guard0x2c5d9d0>),
 i158 = int_add_ovf(i130, 1),
 guard_no_overflow(descr=<Guard0x2c5d690>),
 i159 = int_sub(i133, 6),
 setfield_gc(ConstPtr(ptr68), i159, descr=<FieldS spyvm.interpreter.Interpreter.inst_interrupt_check_counter 24>),
 i160 = int_le(i159, 0),
 guard_false(i160, descr=<Guard0x2c5d410>),
 i161 = arraylen_gc(p88, descr=<ArrayP 4>),
 jump(p0, p3, p6, p8, p10, i158, p14, p20, p22, p24, p26, p28, p30, p32, p34, p36, p38, p40, p42, p44, p46, p48, p50, p52, i57, i62, p88, i75, p64, i71, i127, i159, descr=TargetToken(49528736))
        """)
